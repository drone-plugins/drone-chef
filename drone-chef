#!/usr/bin/env ruby

require 'json'
require 'pathname'
require 'chef/cookbook/metadata'

#
# Parse build data JSON string
#
def build_data
  @build_data ||= JSON.parse ARGV[1]
end

#
# Path to project workspace
#
def workspace
  build_data['workspace']['path']
end

#
# Grab build args from build_data
#
def build_args
  build_data['vargs']
end

#
# Cookbook metadata
#
def cookbook
  @metadata ||= begin
    metadata = Chef::Cookbook::Metadata.new
    metadata.from_file("#{workspace}/metadata.rb")
    metadata
  end
end

#
# Wether or not to freeze the cookbook version during upload
#
def freeze
  @freeze ||= begin
    return true if build_args['freeze'].nil?
    build_args['freeze']
  end
end

#
# Verify required build arguments
#
def verify_reqs # rubocop:disable AbcSize
  puts 'Verifying required arguments'
  fail 'No build data found' if ARGV[1].nil?
  fail 'Username required' unless build_args.key? 'user'
  fail 'Key required' unless build_args.key? 'key'
  fail 'Chef server URL required' unless build_args.key? 'server'
  fail 'Chef organization required' unless build_args.key? 'org'
end

#
# Is cookbook already uploaded at given version?
#
def cookbook_uploaded?
  command = ["knife cookbook show #{cookbook.name} #{cookbook.version}"]
  command << "-c #{knife_rb}"
  `#{command.join(' ')}`
  $?.success? # rubocop:disable SpecialGlobalVars
end

#
# Chef URL based off Chef Server and Org
#
def chef_url
  "#{build_args['server']}/organizations/#{build_args['org']}"
end

def key_path
  '/tmp/drone/key.pem'
end

#
# Write string encoded RSA key to a temporary file
#
def write_key
  puts 'Writing temp key'
  File.open(key_path, 'w') do |f|
    f.write build_args['key']
  end
end

#
# Knife.rb path
#
def knife_rb
  '/tmp/drone/knife.rb'
end

#
# SSL mode when when connecting to chef server
#
def ssl_verify_mode
  return ':verify_peer' unless build_args.key? 'ssl_verify_mode'
  build_args['ssl_verify_mode'] ? ':verify_peer' : ':verify_none'
end

#
# Write knife.rb config
#
def write_knife_rb
  File.open(knife_rb, 'w') do |f|
    f.puts "node_name '#{build_args['user']}'"
    f.puts "client_key '#{key_path}'"
    f.puts "chef_server_url '#{chef_url}'"
    f.puts "cookbook_path '#{Pathname.new(workspace).parent}'"
    f.puts "ssl_verify_mode #{ssl_verify_mode}"
  end
end

#
# Upload the cookbook
#
def upload_cookbook # rubocop:disable AbcSize
  puts "Uploading cookbook #{cookbook.name}@#{cookbook.version}"
  command = ["knife cookbook upload #{cookbook.name}"]
  command << "-c #{knife_rb}"
  command << '--freeze' if freeze
  puts `#{command.join(' ')}`
  fail 'Failed to upload cookbook' unless $?.success? # rubocop:disable SpecialGlobalVars, LineLength
end

######
# MAIN
######
verify_reqs
write_key
write_knife_rb
puts "Checking if #{cookbook.name}@#{cookbook.version} " \
     "is already uploaded to #{chef_url}"
if cookbook_uploaded?
  puts "Cookbook #{cookbook.name} version #{cookbook.version} " \
       "already uploaded to #{chef_url}"
  exit
end
upload_cookbook
